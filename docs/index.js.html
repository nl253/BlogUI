<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import React, { Component } from 'react';
import ReactDOM from 'react-dom';

import { Spinner, Toast, ToastBody, ToastHeader } from 'reactstrap';
import { basename, dirname, join } from 'path-browserify';
import { author } from '../package.json';

import './index.scss';
import bannedWords from './bannedWords.json';
import * as serviceWorker from './serviceWorker';
import {
  countSent,
  countWords,
  findAllMatches,
  fmtHeading,
  getTimeToReadInMin,
  isFile,
} from './utils';
import {
  callCompromiseApi,
  callNaturalApi,
  define,
  getBlogData,
  getPostHTML,
} from './api';


class App extends Component {
  constructor(props) {
    super(props);
    this.bannedWords = new Set(bannedWords);
    this.author = author;
    this.year = new Date(Date.now()).getFullYear().toString();
    this.naturalApiRequests = ['sentiment'];
    this.compromiseApiRequests = [
      'places', 'organizations', 'topics', 'people',
    ];
    this.cache = {
      categories: {},
      posts: {},
      trees: undefined,
      blobs: undefined,
    };
    this.state = {
      _root: null,
      category: null,
      word: null,
      definition: null,
      post: null,
      postText: '',
      _loading: ['_root'],
      ...Object.fromEntries(this.naturalApiRequests.map((e) => [e, null])),
      ...Object.fromEntries(this.compromiseApiRequests.map((e) => [e, []])),
    };
    this.init();
  }

  async init() {
    try {
      this.setState({
        _root: await getBlogData(),
      });
      const path = window.location.pathname;
      if (isFile(path)) {
        this.absPost(path);
      } else {
        this.absCategory(path);
      }
    } catch (e) {
      console.error(e);
    }
    this.endLoading('_root');
  }

  /**
   * @returns {Object&lt;{path: string, url: string, sha: string}>}
   */
  get trees() {
    if (this.cache.trees !== undefined) {
      return this.cache.trees;
    }
    const trees = Object.fromEntries(
      this.state._root.tree
        .filter((node) => node.type === 'tree')
        .sort((a, b) => basename(a.path).localeCompare(basename(b.path)))
        .map((node) => ([node.path, node]))
    );
    this.cache.trees = trees;
    return trees;
  }

  /**
   * @returns {Object&lt;{path: string, url: string, sha: string}>}
   */
  get blobs() {
    if (this.cache.blobs !== undefined) {
      return this.cache.blobs;
    }
    const blobs = Object.fromEntries(this.state._root.tree
      .filter((node) => node.type === 'blob')
      .sort((a, b) => basename(a.path).localeCompare(basename(b.path)))
      .map((o) => [o.path, o]));
    this.cache.blobs = blobs;
    return blobs;
  }

  /**
   * @returns {string}
   */
  get parentCategory() {
    const { category } = this.state;
    return category === '/' ? '/' : dirname(category);
  }

  /**
   * @returns {string[]}
   */
  get parentPosts() {
    if (this.state.category === '/') {
      return [];
    }
    const cat = this.parentCategory;
    return Object
      .values(this.blobs)
      .filter((node) => dirname(node.path) === cat)
      .map((node) => basename(node.path));
  }

  /**
   * @returns {string[]}
   */
  get parentCategories() {
    if (this.state.category === '/') {
      return [];
    }
    const cat = this.parentCategory;
    return Object
      .values(this.trees)
      .filter((node) => dirname(node.path) === cat)
      .map((node) => basename(node.path));
  }

  /**
   * @returns {string[]}
   */
  get posts() {
    const cat = this.state.category;
    const maybeCache = this.cache.posts[cat];
    if (maybeCache !== undefined) {
      return maybeCache;
    }
    const posts = Object.entries(this.blobs)
      .filter(([path, _node]) => dirname(path) === cat)
      .map(([path, _node]) => basename(path));
    this.cache.posts[cat] = posts;
    return posts;
  }

  /**
   * @returns {string[]}
   */
  get categories() {
    const cat = this.state.category;
    const maybeCache = this.cache.categories[cat];
    if (maybeCache !== undefined) {
      return maybeCache;
    }
    const categories = Object
      .entries(this.trees)
      .filter(([path, _node]) => dirname(path) === cat)
      .map(([path, _node]) => basename(path));
    this.cache.categories[cat] = categories;
    return categories;
  }

  /**
   * @param {string} post
   */
  async absPost(post) {
    if (this.state.category === dirname(post) &amp;&amp; this.state.post === basename(post)) {
      return;
    }
    this.beginLoading('postText');
    window.history.pushState({}, `post ${basename(post)}`, post);
    this.setState({
      category: dirname(post),
      post: basename(post),
      postText: '',
    });
    const postBlob = this.blobs[post];
    if (!postBlob) {
      console.warn(`could not find blob for post ${post}`);
      return;
    }
    try {
      const postText = await getPostHTML(postBlob.sha);
      this.setState({ postText });
      this.endLoading('postText');
      if (this.state.postText) {
        const p = Promise.all([
          ...this.naturalApiRequests.map(async (type) => {
            this.setState({ [type]: null });
            this.beginLoading(type);
            this.setState({
              // eslint-disable-next-line react/no-access-state-in-setstate
              [type]: await callNaturalApi(this.state.post, this.state.category, this.getPostBody(), type),
            });
            this.endLoading(type);
          }),
          ...this.compromiseApiRequests.map(async (type) => {
            this.setState({ [type]: [] });
            this.beginLoading(type);
            this.setState({
              // eslint-disable-next-line react/no-access-state-in-setstate
              [type]: await callCompromiseApi(this.state.post, this.state.category, this.getPostBody(), type),
            });
            this.endLoading(type);
          })
        ]);
        this.makeClickable('#post-text p, #post-text li');
        this.registerDefinitionsOnWordClick('#post-text p .word, #post-text li .word');
        this.fixImgSrc();
        await p;
      }
    } catch (e) {
      console.error(e);
    }
  }

  /**
   * @param {string} selector
   */
  makeClickable(selector) {
    const nodes = document.querySelectorAll(selector);
    for (const n of nodes) {
      for (const child of n.childNodes) {
        if (child.nodeName === '#text') {
          const matches = findAllMatches(child.nodeValue, /([A-Za-z]{2,})/g);
          for (const w of new Set(matches)) {
            if (!this.bannedWords.has(w)) {
              n.innerHTML = n.innerHTML.replace(new RegExp(`\\b${w}\\b`, 'g'), `&lt;button class="word">${w}&lt;/button>`);
            }
          }
        }
      }
    }
  }

  /**
   * @param {string} selector
   */
  registerDefinitionsOnWordClick(selector) {
    for (const node of document.querySelectorAll(selector)) {
      node.addEventListener('click', async () => {
        const word = node.innerText;
        try {
          const definition = await define(word);
          if (definition) {
            this.setState({ word, definition });
            this.makeClickable('.toast > .toast-body');
            this.registerDefinitionsOnWordClick('.toast > .toast-body .word');
          }
        } catch (e) {
          console.error(e);
        } finally {
          this.endLoading('word');
        }
      });
    }
  }

  fixImgSrc() {
    for (const img of document.querySelectorAll('img[src]')) {
      const src = img.getAttribute('src');
      if (src &amp;&amp; !src.startsWith('http')) {
        img.setAttribute('src', join(process.env.REACT_APP_ASSETS_ROOT, this.state.category.substr(1), src));
      }
    }
  }

  /**
   * @param {string} what
   */
  beginLoading(what) {
    this.setState(({ _loading }) => ({ _loading: [..._loading, what] }));
  }

  /**
   * @param {string} what
   */
  endLoading(what) {
    this.setState(({ _loading }) => {
      for (let i = 0; i &lt; _loading.length; i++) {
        if (_loading[i] === what) {
          return {
            _loading: _loading.slice(0, i).concat(_loading.slice(i + 1)),
          };
        }
      }
    });
  }

  /**
   * @param {string} item
   * @returns {boolean}
   */
  didLoad(...item) {
    return item.reduce((prev, focus) => prev &amp;&amp; this.state._loading.indexOf(focus) &lt; 0, true);
  }

  /**
   * @param {string} category
   */
  absCategory(category) {
    if (this.state.category !== category) {
      if (category === '') {
        this.absCategory('/');
      } else if (category.length > 1 &amp;&amp; category.endsWith('/')) {
        this.absCategory(category.replace(/\/$/, ''));
      } else {
        window.history.pushState(undefined, `category ${basename(category)}`, category);
        this.setState({ category });
      }
    }
  }

  /**
   * @returns {string}
   */
  getPostBody(slice = true) {
    const s = [...document.getElementById('post-text').querySelectorAll('p')].map((p) => p.innerText).join('\n');
    return slice ? s.slice(0, 10000) : s;
  }

  /**
   * @returns {*}
   */
  render() {
    const { definition, category, post, word, postText } = this.state;
    return (
      this.didLoad('_root')
      &amp;&amp; (
        &lt;div>
          &lt;Toast
            isOpen={!!definition}
            className="d-sm-none d-md-none d-lg-block d-xl-block"
            style={{ position: 'fixed', zIndex: 99, bottom: '10px', left: '10px' }}
            transition={{ exit: false, timeout: 10, enter: true, appear: true }}
            onClick={() => this.setState({ word: null, definition: null })}
          >
            &lt;ToastHeader>{word}&lt;/ToastHeader>
            &lt;ToastBody>{definition}&lt;/ToastBody>
          &lt;/Toast>
          &lt;main className="container-fluid mt-0 mt-xl-5 mt-lg-5 mt-md-0 mt-sm-0 d-flex no-gutters flex-column flex-xl-row flex-lg-row flex-md-row flex-sm-column" style={{ minHeight: '84vh' }}>
            &lt;section className="col-xl-2 col-lg-2 d-none d-xl-block d-lg-block d-md-none d-sm-none">
              {this.parentCategories.length > 0 &amp;&amp; (
                this.parentCategory.length === 1
                  ? (
                    &lt;div>
                      &lt;h1 className="text-center mx-auto display-4">Blog&lt;/h1>
                      &lt;hr style={{ maxWidth: '75%' }} />
                    &lt;/div>
                  ) : (
                    &lt;div>
                      &lt;h2 className="text-center mx-auto">
                        {fmtHeading(basename(this.parentCategory))}
                      &lt;/h2>
                      &lt;hr />
                    &lt;/div>
                  )
              )}
              {this.parentCategories.length > 0 &amp;&amp; (
                &lt;nav>
                  {this.parentCategories.map((c, idx) => (
                    &lt;button
                      type="button"
                      onClick={() => this.absCategory(join(this.parentCategory, c))}
                      key={idx}
                      className={`d-block btn mx-auto w-75 btn-${category.substr(1) === c ? 'warning' : 'link'}`}
                    >
                      {fmtHeading(c)}
                    &lt;/button>
                  ))}
                &lt;/nav>
              )}
              {this.parentPosts.length > 0 &amp;&amp; (
                &lt;div>
                  {this.parentCategories.length > 0 &amp;&amp; &lt;hr style={{ maxWidth: '75%' }} />}
                  &lt;h3 className="text-center mt-3 mx-auto">Posts&lt;/h3>
                  &lt;nav>
                    {this.parentPosts.map((p, idx) => (
                      &lt;button
                        type="button"
                        onClick={() => this.absPost(join(this.parentCategory, p))}
                        key={idx}
                        className={`d-block btn mx-auto w-75 btn-${post === p ? 'light' : 'link'}`}
                      >
                        {fmtHeading(p)}
                      &lt;/button>
                    ))}
                  &lt;/nav>
                &lt;/div>
              )}
            &lt;/section>
            &lt;section className="col-xl-2 col-lg-2 col-md-3 col-sm-12 my-4 my-xl-0 my-lg-0 my-md-4 my-sm-4">
              &lt;div className="text-center col mx-auto">
                {category === '/'
                  ? (
                    &lt;div>
                      &lt;h1 className="text-center mx-auto display-4">Blog&lt;/h1>
                      &lt;hr style={{ maxWidth: '75%' }} />
                    &lt;/div>
                  )
                  : (
                    &lt;div>
                      &lt;h2>{fmtHeading(basename(category))}&lt;/h2>
                      &lt;button
                        type="button"
                        className="btn btn-light d-block w-50 mx-auto border"
                        onClick={() => this.absCategory(this.parentCategory)}
                      >
                      Back
                      &lt;/button>
                    &lt;/div>
                  )}
              &lt;/div>
              &lt;div>
                {this.categories.length > 0 &amp;&amp; (
                  &lt;nav>
                    {this.categories.map((c, idx) => (
                      &lt;button
                        type="button"
                        onClick={() => this.absCategory(join(category, c))}
                        key={idx}
                        className="d-block btn mx-auto w-75 btn-link"
                      >
                        {fmtHeading(c)}
                      &lt;/button>
                    ))}
                  &lt;/nav>
                )}
                {this.posts.length > 0 &amp;&amp; (
                  &lt;div>
                    {this.categories.length > 0 &amp;&amp; &lt;hr style={{ maxWidth: '75%' }} />}
                    &lt;h3 className="text-center mt-3 mx-auto">Posts&lt;/h3>
                    &lt;nav>
                      {this.posts.map((p, idx) => (
                        &lt;button
                          type="button"
                          onClick={() => this.absPost(join(category, p))}
                          key={idx}
                          className={`d-block btn w-75 mx-auto btn-${post === p ? 'warning' : 'link'}`}
                        >
                          {fmtHeading(p)}
                        &lt;/button>
                      ))}
                    &lt;/nav>
                  &lt;/div>
                )}
              &lt;/div>
            &lt;/section>
            {this.didLoad('postText') &amp;&amp; postText &amp;&amp; (
              &lt;section className="col-xl col-lg col-md-9 col-sm-12 container-fluid row justify-content-around">
                &lt;div className="col-xl-3 col-lg-3 d-md-none d-sm-none" />
                &lt;section className="col-xl-6 col-8-lg col-12-md col-12-sm">
                  &lt;div
                    id="post-text"
                    dangerouslySetInnerHTML={{ __html: postText }}
                    className="my-4 my-xl-0 my-lg-0 my-md-4 my-sm-4"
                  />
                &lt;/section>
                &lt;div className="col-xl-1 col-lg-1 d-md-none d-sm-none" />

                &lt;section className="col-xl-1 col-lg-1 d-none d-xl-block d-lg-block d-md-none d-sm-none">
                  &lt;h3>Info&lt;/h3>
                  &lt;p className="mb-1">{getTimeToReadInMin(postText)} min read&lt;/p>
                  &lt;p className="mb-1">{countWords(postText)} words&lt;/p>
                  &lt;p>{countSent(postText)} sentences&lt;/p>
                  &lt;div>
                    {this.compromiseApiRequests
                      .filter((type) => !!this.state[type] &amp;&amp; this.state[type].length > 0)
                      .map((type, typeIdx) => (
                        &lt;div key={typeIdx}>
                          &lt;h4>{type.substr(0, 1).toUpperCase()}{type.substr(1)}&lt;/h4>
                          &lt;ul style={{ listStyleType: 'none', padding: 0, margin: 0 }}>
                            {this.state[type].map((t, tIdx) => (
                              &lt;li key={tIdx}>
                                &lt;p style={{ fontVariantCaps: 'all-petite-caps' }}>{t}&lt;/p>
                              &lt;/li>
                            ))}
                          &lt;/ul>
                        &lt;/div>
                      ))}

                    {this.naturalApiRequests
                      .filter((type) => !!this.state[type])
                      .map((type, typeIdx) => (
                        &lt;div key={typeIdx}>
                          &lt;h4>{type.substr(0, 1).toUpperCase()}{type.substr(1)}&lt;/h4>
                          &lt;p style={{ fontVariantCaps: 'all-petite-caps' }}>{this.state[type].toFixed(2)}&lt;/p>
                        &lt;/div>
                      ))}
                  &lt;/div>
                &lt;/section>
                &lt;div className="col-xl-1 col-lg-1 d-md-none d-sm-none" />
              &lt;/section>
            )}
            {!this.didLoad('postText') &amp;&amp; (
              &lt;div className="mx-auto my-auto">
                &lt;Spinner style={{ width: '3rem', height: '3rem' }} />
              &lt;/div>
            )}
          &lt;/main>
          &lt;footer className="py-4 bg-light d-none d-xl-block d-lg-block d-md-block d-sm-block border-top mt-xl-3 mt-1 mt-lg-3 mt-md-1 mt-sm-1">
            &lt;div className="mx-auto mt-2 mb-4" style={{ maxWidth: '370px' }}>
              &lt;span className="mr-3">
                &lt;a
                  href="https://www.linkedin.com/in/norbert-logiewa"
                  className="btn btn-sm btn-secondary"
                  style={{ minWidth: '80px' }}
                >
                  LinkedIn
                &lt;/a>
              &lt;/span>
              &lt;span className="mr-3">
                &lt;a
                  href="https://github.com/nl253"
                  className="btn btn-sm btn-secondary"
                  style={{ minWidth: '80px' }}
                >
                  GitHub
                &lt;/a>
              &lt;/span>
              &lt;span className="mr-3">
                &lt;a
                  href="https://docs.google.com/document/d/1I94ZHc_75a2ivyjcDXjESIrGYPmJUriTm3xmEkcwaeI/edit?usp=sharing"
                  className="btn btn-sm btn-secondary"
                  style={{ minWidth: '80px' }}
                >
                  CV
                &lt;/a>
              &lt;/span>
              &lt;span>
                &lt;a
                  href="https://portfolio-nl.herokuapp.com"
                  className="btn btn-sm btn-secondary"
                  style={{ minWidth: '80px' }}
                >
                  Portfolio
                &lt;/a>
              &lt;/span>
            &lt;/div>
            &lt;p className="text-center mx-auto">Copyright &amp;copy; {this.author.name} {this.year}&lt;/p>
          &lt;/footer>
        &lt;/div>
      )
    );
  }
}

ReactDOM.render(&lt;App />, document.getElementById('root'));
serviceWorker.unregister();
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#callCompromiseApi">callCompromiseApi</a></li><li><a href="global.html#callNaturalApi">callNaturalApi</a></li><li><a href="global.html#checkValidServiceWorker">checkValidServiceWorker</a></li><li><a href="global.html#countSent">countSent</a></li><li><a href="global.html#countWords">countWords</a></li><li><a href="global.html#define">define</a></li><li><a href="global.html#findAllMatches">findAllMatches</a></li><li><a href="global.html#fmtHeading">fmtHeading</a></li><li><a href="global.html#getBlogData">getBlogData</a></li><li><a href="global.html#getPostHTML">getPostHTML</a></li><li><a href="global.html#getTimeToReadInMin">getTimeToReadInMin</a></li><li><a href="global.html#isDotFile">isDotFile</a></li><li><a href="global.html#isFile">isFile</a></li><li><a href="global.html#register">register</a></li><li><a href="global.html#registerValidSW">registerValidSW</a></li><li><a href="global.html#unique">unique</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sun Dec 29 2019 12:05:48 GMT+0000 (Greenwich Mean Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
